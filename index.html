<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- BOOTSTRAP -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <!-- Code input -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/gh/WebCoder49/code-input@1.1/code-input.min.css"
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link
      id="import-theme"
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/themes/prism-okaidia.css"
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <!-- bootswatch theme -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/5.2.3/solar/bootstrap.min.css"
      integrity="sha512-SGLY63IpxQgjNZfOfmayBxXeh5Uw6/b3ZgAxONQb9OW5MosjvFOPmT6aTgLEerDOTc03knEaeeTdV6q5lOkLKw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <title>StationIO</title>
  </head>
  <body>
    <div class="modal fade" id="pluginModal" tabindex="-1" aria-labelledby="pluginModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="pluginModalLabel">StationIO Plugin</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="text-center">Click on the plugin you want to add :</div>
              <div class="col">
                <ul id="plugins-list">
                  <li><a href="plugins/custom-i2c-pins.js" data-bs-dismiss="modal">Custom I2C pins</a></li>
                  <li><a href="plugins/wifi-repeater.js" data-bs-dismiss="modal">Simple Wifi repeater</a></li>
                  <li><a href="plugins/IR-tansmitter.js" data-bs-dismiss="modal">IR Remote</a> (custom endpoint and 21,24,44 buttons remote)</li>
                  <li><a href="plugins/mini-hub-generator.js" data-bs-dismiss="modal">Minihub</a> WiP(tm)</li>
                </ul>
              </div>
            </div>
            <div class="row">
              <div class="text-center">Or add your own plugin :</div>
              <div class="form-group" id="external-plugin-input">
                <label for="external-plugin-url">Plugin URL</label>
                <input type="text" class="form-control" id="external-plugin-url" placeholder="https://example.com/plugin.js" />
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" onclick="addScript(document.getElementById('external-plugin-url').value)"
              data-bs-dismiss="modal">Add Plugin</button>
          </div>
        </div>
      </div>
    </div>
    <div class="container">
      <h1>StationIO</h1>
      <div class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
        <nav class="nav nav-tabs">
          <a
            href="#"
            class="nav-link active"
            id="nav-about"
            navTo="about"
            >About</a
          >
          <a href="#" class="nav-link" id="nav-config" navTo="config"
            >Configuration</a
          >
          <a href="#" class="nav-link" id="nav-install" navTo="install"
            >Install</a
          >
          <a
            href="#"
            class="nav-link"
            id="nav-main-cpp"
            navTo="main-cpp"
            >main.cpp</a
          >
          <a
            href="#"
            class="nav-link"
            id="nav-custom-sensors"
            navTo="custom-sensors"
            >Sensors</a
          >
          <a id="nav-github" href="https://github.com/DimitriGilbert/StationIO-Station" target="_blank">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="40" height="40">
              <path
                d="M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z">
              </path>
            </svg>
          </a>
        </nav>
      </div>
      <div id="stationio-about" class="stio-tab">
        <h2>What is StationIO ?</h2>
        <p>
          An Arduino framework-ish thingy that takes care of the (my?) basics !<br/>
          It runs on ESP8266 and ESP32 boards, connects to WiFi, provides a webserver (with basic endpoints), use a file system, support a bunch of sensor out of the box 
          and provides an easy way to execute function on a timer.
        </p>
        <h2>How does it work ?</h2>
        <p>
          It uses a set of classes to handle the basic station, sensors, callbacks on a
          timer and web server endpoints, while still being arduino code.<br />
          That way you can hookup your custom code in a breeze.<br />
          There are a few (very inventivelly named) bash scripts to handle common tasks :
          <ul>
            <li><a href="https://github.com/DimitriGilbert/StationIO-Station/blob/main/utils/createStation">utils/createStation</a>, creates a station</li>
            <li><a href="https://github.com/DimitriGilbert/StationIO-Station/blob/main/utils/uploadStation">utils/uploadStation</a>, uploads a station</li>
            <li><a href="https://github.com/DimitriGilbert/StationIO-Station/blob/main/utils/buildFS">utils/buildFS</a>, builds the file system</li>
          </ul>
          All the script have plenty of options that are documented, so just use --help to get all the infos.
        </p>
        <h2>But.... WHY ?</h2>
        <p>
          I know there are plenty of great iot stack out there but I do not like
          their architecture, it is too centralized to my taste. I'd rather have independent microservices that can be queried by
          whatever wants to. <br />
          So instead of stations reporting to a central hub, I can have my hub
          query the stations, stations querying each others, computers querying
          stations and even stations reporting to a hub (....yep, I know).<br />
          Freedooooooom.... <br />
          Also, I find it a bit annoying to waste "so much" computing power (I
          know it sounds weird to read) on an interpreter (for micropython) or
          doing nothing (a few MQQT message an hour). <br />
          ESPes have a good chunk of power and can easily handle a webserver and
          "on the edge" processing, not just executing command and reporting
          values.<br />
          Another thing, doing stuff on arduino considering I have no idea what I'm doing is mostly copy/pasting...And I really HATE copy/pasting....! StationIO is more or less an "Arduino project copy/paste manager" XD...
        </p>
        <h2>Huuum.... how do you get that running then ?</h2>
        <p>
          <ul>
            <li>Grab an esp8266 or esp32 boards</li>
            <li>Plug it to your conputer</li>
            <li>Use the <a href="#" navTo="config">Configuration</a> tool</li>
            <li>Follow the <a href="#" navTo="install">Install</a> script</li>
            <li>Build your circuit (don't look at me I have fat fingers !)</li>
            <li>Go to your device ip (you can use the "/fancy" endpoint for more eyecandy-ish, me no designer ok ! oh, and I don't care how it looks :P)</li>
            <li>Voila !!(maybe...tm)</li>
          </ul>
        </p>
        <h2>But it's for linux and I run windows (useless nerd !)</h2>
        <p>
          Well I dunno... use <a href="https://learn.microsoft.com/en-us/windows/wsl/install" target="_blank" rel="noopener noreferrer">WSL</a> or <a href="https://learn.microsoft.com/en-us/virtualization/hyper-v-on-windows/about/" target="_blank" rel="noopener noreferrer">something</a> ...<br/>
          Note that PIO is a python tool, so it should work on windows too, but I did not try it. And you really do not have to use my utils scripts (that are written in bash), just use PIO directly (I use the vscode extension while working on my stations).
        </p>
        <h2>What about MacOS ?</h2>
        <p>Look pal, I ain't responsible for your poor life choices, now if you care to donate a mac (those M2 pro minis look sweeeet) I promise to add support, how's that ?</p>
        <h2>Can you integrate with other IoT stacks ?</h2>
        <p>
          Huuuum, ...., I did not even try ^^'. <br />
          It should be easy though, if your stack can fetch info with http
          queries, no problemo ! <br />
          On the "/" endpoint, you can set the "Accept" header to "application/json",
          "application/xml","text/csv", "text/plain" and you'll get a
          corresponding response. It also works with the get attribute "format". Default is html<br />
          For more information, use the "/openapi" endpoint, it will give you a OpenApi doc file that 
          you can use <a href="https://editor.swagger.io/" target="_blank" rel="noopener noreferrer">there</a> 
          for more details (yes, if you use addEndpoint, they'll appear too :D)<br />
          If you need MQTT, or other protocols, you should be able to integrate
          with timer callbacks, I think... <br />
          If timer callbacks do not work, fear not, you can still use standard
          arduino code, in the exact same way as before. (declaration, setup,
          loop)
        </p>
        <h2>What's your use case ?</h2>
        <p>
          At home I have several stations (more or less in every room) that run
          StationIO with a panache of sensors (the ones implemented as a matter
          of suprising fact) to report temperature, humidity, and so on... <br />
          I have a Rpi running a docker-compose stack with a mysql database, a
          grafana instance and a nodejs instance. <br />
          A cronjob on the Rpi fetches the data from the stations and inserts it
          into the database and my computer displays several widgets that fetch data from the
          stations in real time for a quick look. <br />
          Also, some stations talk to each other in order to decide
          what actions to execute. For example, I heat my upper floors using hot air taken from above my wood stove. <br/>
          All fans are controlled by a station that uses intake air temperature, my main room temperature and the heated room temperature to decide what speed to run them at.<br />
          I plan on "smartifying" (cough) my garden and greenhouse (hence the Wifi extender) the spring so I'll probably update a few things here and there.
        </p>
        <h2>Could you add support for ...</h2>
        <p>
          WOOOooow wow, heeeyy there, how ya doin' ? Huum, I'm sorry but I'm afraid not (for now).<br />
          If you want a sensor that is not supported, you can add a "custom" sensor in the configuration tool, fill up the form, and boom, it'll generate the (basic) code in the "sensor" tab. <br />
          I know it's not perfect, buuut, once you added and tested your sensor, make a pull request so the next lad can benefit from our collective work ! <br />
          <br />
          Now, if you want to modify/add/whatever js or css files (or any other type for that matter), put them in "src/assets/...". you can then use the built-in script "utils/buildFS" to build and upload the file system.<br />
          Use "utils/buildFS --help" for more info.<br /><br />
          Also, if you want, you can load a <a href="#" onclick="new bootstrap.Modal('#pluginModal', {}).show()">plugin</a>
        </p>
        <h2>Plugins ? What plugins ?</h2>
        <p>
          As of now, I have a few :
          <ul>
            <li>A way to set custom I2C pins</li>
            <li>A simple and (kindda) customizable Wifi repeater/extender (taken from esp8266 arduino example ^^)</li>
            <li>An Infrared Remote with support for 21, 24 and 44 buttons generic remotes plus an endpoint you can customize to support other things</li>
          </ul>
        </p>
        <h2>How does it work ? Can I make one ?!?</h2>
        <p>
          NOOooow we're talking ! <br />
          "Plugins"  are just javascript files that I load after the initial load, I do not control ANYthing you are doing, (AT ALL)<br />
          Want to add html somewhere ? sure !<br />
          Add event listeners ? why not.<br />
          Overhaul the look and feel of the generator ? HELL YEAH !<br />
          The plugin "api" also provides a way to hook into the templates, so you can add your own stuff to the generated code.<br />
          Go and have a look at the <a href="https://github.com/DimitriGilbert/StationIO-Station/blob/main/plugins/IR-tansmitter.js">IR remote plugin</a> to get an example.<br />
          If you made something cool you'd like to share, don't hesitate to make a <a href="https://github.com/DimitriGilbert/StationIO-Station/pulls">pull request</a> so I can add it to the list of plugins !
        </p>
        <h2>Duuuude, your code is trash, that's not how how you do..., ...</h2>
        <p>
          Yuuuup, I'm not too proud of a few things, how sensor work for example, how do you do proper inheritance and stuff in C++ anyway ? Yes my interfaces are all other the place, I guess you haven't seen my office ^^'. Strings are bad they say ! Meh!, maybe.) <br />
          I'll gladly take a bit of time to make things better so any suggestions/fingers in the right direction/examples are very welcome !
          Use github's issues to report things, or make a pull request !
        </p>
        <h2>Can I use it for my project ?</h2>
        <p>
          That's what the license says :). Don't expect extensive and ultra responsive support, but if you encounter bug with my core code or the generated one, please open an <a href="https://github.com/DimitriGilbert/StationIO-Station/issues">issue</a> on github.<br />
          I'll do my best to fix things as this is the codebase for MY home automation (I'd like to keep it "bug free" :P)
        </p>
      </div>
      <div id="stationio-config" class="d-none stio-tab">
        <p>
          This tool will help you to generate a StationIO station. You can
          configure your station, each modification regenerates the code for the
          main file in <a href="#" navTo="main-cpp">main.cpp</a>
          as well as <a href="#" navTo="install">installation</a> instructions/script.
        </p>
        <form id="stationio-config-frm">
          <div class="row gx-5" id="configs">
            <div class="col">
              <h2 class="text-center">Main config</h2>
              <div class="row">
                <label for="station-name">Station Name</label>
                <input
                  type="text"
                  class="form-control"
                  name="station-name"
                  id="station-name"
                  placeholder="Station Name"
                />
              </div>
              <div id="wifi-config" class="row">
                <div class="col">
                  <label for="wifi-ssid">WiFi SSID</label>
                  <input
                    type="text"
                    class="form-control"
                    id="wifi-ssid"
                    name="wifi-ssid"
                  />
                </div>
                <div class="col">
                  <label for="wifi-pass">WiFi password</label>
                  <input
                    type="password"
                    class="form-control"
                    id="wifi-pass"
                    name="wifi-pass"
                  />
                </div>
              </div>
              <div id="timers-config" class="row">
                <h2 class="text-center">Timers config</h2>
                <div>
                  <input
                    type="hidden"
                    name="timers-count"
                    id="timers-count"
                    value="0"
                  /><button
                    type="button"
                    id="addTimerButton"
                    class="btn btn-primary btn-lg"
                  >
                    Add a timer
                  </button>
                </div>
                <div id="timers-list"></div>
              </div>
            </div>
            <div class="col">
              <h2 class="text-center">Sensor config</h2>
              <div id="sensor-config">
                <div class="row align-items-center">
                  <div class="col-10">
                    <label for="sensor-select">Select a sensor</label>
                    <select
                      class="form-select"
                      name="sensor-select"
                      id="sensor-select"
                    >
                      <option id="sensor-opt-dht11" value="dht11" mesures="temperature,humidity" libs="adafruit/DHT sensor library">dht11</option>
                      <option id="sensor-opt-bmp280" value="bmp280" mesures="temperature,pressure,altitude" libs="adafruit/Adafruit BMP280 Library">bmp280</option>
                      <option id="sensor-opt-bme280" value="bme280" mesures="temperature,pressure,humidity,altitude" libs="adafruit/Adafruit BME280 Library">bme280</option>
                      <option id="sensor-opt-bmp085" value="bmp085" mesures="temperature,pressure,altitude" libs="adafruit/Adafruit BMP085 Library">bmp085</option>
                      <option id="sensor-opt-sht21" value="sht21" mesures="temperature,humidity,compensated_humidity" libs="git@github.com:enjoyneering/HTU2xD_SHT2x_Si70xx.git">sht21</option>
                      <option id="sensor-opt-mq2" value="mq2" mesures="LPG,H2,CO,Alcohol,Propane,raw" libs="git@github.com:DimitriGilbert/MQSensorsLib.git">mq2</option>
                      <option id="sensor-opt-mq135" value="mq135" mesures="CO,Alcohol,CO2,Toluen,NH4,Aceton,raw" libs="git@github.com:DimitriGilbert/MQSensorsLib.git">mq135</option>
                      <option id="sensor-opt-ccs811" value="ccs811" mesures="" libs="">ccs811</option>
                      <option id="sensor-opt-linky" value="linky" mesures="HCHP,HCHC,PTEC,PAPP" libs="hallard/LibTeleinfo">linky</option>
                      <option id="sensor-opt-custom" value="custom">custom</option>
                    </select>
                  </div>
                  <div class="col-2">
                    <button
                      class="btn btn-lg btn-primary"
                      type="button"
                      id="addSensorButton"
                    >
                      Add
                    </button>
                  </div>
                </div>
                <input type="hidden" name="sensor-index" id="sensor-index" value="0">
                <div class="row" id="sensors-list"></div>
              </div>
              <div class="row" id="endpoint-config">
                <h2 class="text-center">Endpoint Config</h2>
                <div>
                  <input
                    type="hidden"
                    name="endpoint-count"
                    id="endpoint-count"
                    value="0"
                  /><button
                    type="button"
                    id="addEndpointButton"
                    class="btn btn-primary btn-lg"
                  >
                    Add an endpoint
                  </button>
                </div>
                <div id="endpoints-list"></div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div id="stationio-install" class="d-none stio-tab">
        <div>
          <p>This install guide is for linux systems. It is bash so little to no effort shoud go into running it on mac (I don't have one)<br/>
            As said in the About section, windows user should use WSL, I know I could install a VM but I have no use for it. If you tried and had to do special things to make it work, 
            please open an <a href="https://github.com/DimitriGilbert/StationIO-Station/issues">issue</a> with the relevant information so I can update the install script.</p>
          </p>
          <p>
            <a href="https://platformio.org/install/cli">PlateformIO</a>
          </p>
        </div>
        <form action="" id="install-config-frm">
          <div class="row">
            <div class="col">
              <label for="install-station-name">Station Name</label>
              <input
                type="text"
                class="form-control"
                name="install-station-name"
                id="install-station-name"
                placeholder="Station Name"
              />
            </div>
            <div class="col">
              <label for="install-station-type">install type</label>
              <select
                class="form-select"
                name="install-station-type"
                id="install-station-type"
              >
                <option value="git">git</option>
                <option value="tgz">tgz</option>
                <option value="none">none</option>
              </select>
            </div>
            <div class="col">
              <label class="form-check-label" for="install-station-pio">install PlatformIO</label>
              <input
                type="checkbox"
                class="form-check-input"
                name="install-station-pio"
                id="install-station-pio"
                checked
              />
            </div>
          </div>
        </form>
        <code-input lang="bash" id="install-output">Please fill the config form</code-input>
      </div>
      <div id="stationio-main-cpp" class="d-none stio-tab">
        <code-input lang="Arduino" id="main-cpp-output">// Nothing to see here
// please fill the configuration form !</code-input>
      </div>
      <div id="stationio-custom-sensors" class="d-none stio-tab">
        No custom sensor defined yet
      </div>
    </div>
    <script id="common.js">
      function addScript(src, delay) {
        setTimeout(() => {
          var script = document.createElement("script");
          script.setAttribute("src", src);
          script.setAttribute("crossorigin", "anonymous");
          document.body.appendChild(script);
        }, delay||50)
      }
      function navTo(where) {
        document.querySelectorAll(".nav-link").forEach((el) => {
          el.classList.remove("active");
        });
        document.querySelector("#nav-" + where).classList.add("active");
        document.querySelectorAll(".stio-tab").forEach((el) => {
          el.classList.add("d-none");
        });
        document
          .querySelector("#stationio-" + where)
          .classList.remove("d-none");
      }
      /**
       * https://stackoverflow.com/a/35385518
       * @param {String} HTML representing any number of sibling elements
       * @return {NodeList}
       */
      function htmlToElements(html) {
        var template = document.createElement("template");
        template.innerHTML = html;
        return template.content.firstChild;
      }

      // main tpl
      var mainCppTpl = `#include <Arduino.h>
#include <Wire.h>
#include "./Station.h"

<% if(it.sensors!==undefined && it.sensors.length > 0){%>
// including sensors
<% it.sensors.forEach(function(sensor){
sensorname = sensor;
if(typeof sensor !== "string"){
  sensorname = sensor[0];
}%>
#include "./sensors/<%=sensorname %>.h"
<%})}%>
<% if(it.plugins !== undefined && it.plugins.include !== undefined && it.plugins.include !== ""){%>
// including plugins
<%~ it.plugins.include %>
<%}%>
// initializing station
StationClass station(
  "<%= it.name %>"<% if(it.wifi!==undefined){%> ,
  {
    ssid : "NEVER PUT YOUR WIFI INFO",
    password : "IN A RANDOM FORM ON THE WEB !! !"
  }
<% } %>);

<% if(it.sensors!==undefined && it.sensors.length > 0){%>
// ___ sensors ___
<% it.sensors.forEach(function(sensor){
if(typeof sensor !== "string" && sensor.length !== undefined && sensor.length > 2){%> 
<%~ sensor[2] %> 
<%}})
%>
Sensor* sensors[<%= it.sensors.length %>] = {<% it.sensors.forEach(function(sensor){
sensorArg = "";
sensorname = sensor;
if(typeof sensor !== "string"){
  sensorArg = sensor[1];
  sensorname = sensor[0];
}
%> 
  new <%= sensorname %>(<%= sensorArg %>),<%})%> 
};

<%}
if(it.callbacks!==undefined && it.callbacks.length > 0){if(it.callbacks.length > 0){%>
// ___ callbacks ___
<% it.callbacks.forEach(function(cb){%>
<%= cb %><%})%> 

<%}}
if(it.loops!==undefined && it.loops.length > 0){if(it.loops.length > 0){%>
// ___ loops ___
BaseStation::StationCallback_t* loopsCallbacks[<%= it.loops.length %>] = {<% it.loops.forEach(function(loop){%> 
  <%= loop %>,<%})%> 
};

<%}}
if(it.timers!==undefined && it.timers.length > 0){if(it.timers.length > 0){%>
// ___ timers ___
BaseStation::StationCallbackTimer_t timers[<%= it.timers.length %>] = {<% it.timers.forEach(function(timer){%> 
  // <%= timer.name!==undefined?timer.name:"" %> 
  {
    <%~ timer.callback %>,
    <%= timer.interval %>
  },<%})%> 
};

<%}}
if(it.webServerRoutes!==undefined && it.webServerRoutes.length > 0){if(it.webServerRoutes.length > 0){%>
// ___ web Server ___
<% it.webServerRoutes.forEach(function(route, epi){%> 
  EspStation::StationWebCallbackInfo_t endpoint_<%= epi %> = {"<%= route.url %>", "<%= route.login %>", "<%= route.password %>", <%~ route.callback %>};<%})%> 

<%}}%>
<% if(it.plugins !== undefined && it.plugins.declaration !== undefined && it.plugins.declaration !== ""){%>
// declaring plugins
<%~ it.plugins.declaration %>
<%}%>

void setup() {
  Wire.begin(<%= it.i2c!==undefined?(it.i2c[0]+", "+it.i2c[1]):""%>);
  station.setup();

  <% if(it.sensors!==undefined && it.sensors.length > 0){%>// setting up sensors
  station.setupSensors(sensors, <%= it.sensors.length %>);

  <%}
  if(it.loops!==undefined && it.loops.length > 0){%>// setting up loops
  station.setupLoopCallback(loops, <%= it.loops.length %>);

  <%}
  if(it.timers!==undefined && it.timers.length > 0){%>// setting up timers
  station.setupTimers(timers, <%= it.timers.length %>);

  <%}
  if(it.webServerRoutes!==undefined && it.webServerRoutes.length > 0){%>// setting up web Server
  <% it.webServerRoutes.forEach((ret,epi) => {%>station.addEndpoint(endpoint_<%= epi %>);
  <%}) %>
<%}%>
  // setting up OTA
  station.setupOTA();

  // ___ custom code goes here ___
<% if(it.plugins !== undefined && it.plugins.setup !== undefined && it.plugins.setup !== ""){%>
  
  // setting up plugins
  <%~ it.plugins.setup %>
<%}%>
}

void loop() {
  station.loop();
  <% if(it.sensors!==undefined && it.sensors.length > 0){%>
<% it.sensors.forEach(function(sensor){
if(typeof sensor !== "string" && sensor.length !== undefined && sensor.length > 3){%> 
  // <%= sensor[0] %>

<%~ sensor[3] %> 

<%}})}%>
  // ___ custom code goes here ___
<% if(it.plugins !== undefined && it.plugins.loop !== undefined && it.plugins.loop !== ""){%>
  
  // loop plugins
  <%~ it.plugins.loop %>
<%}%>
}
`;
      
      // Install tpl
      var installPIOtpl = `# Install PlatformIO 
# https://docs.platformio.org/en/latest/installation.html
python3 -c "$(curl -fsSL https://raw.githubusercontent.com/platformio/platformio/master/scripts/get-platformio.py)"

# Install udev rules
# https://docs.platformio.org/en/latest/core/installation/udev-rules.html
curl -fsSL https://raw.githubusercontent.com/platformio/platformio-core/develop/platformio/assets/system/99-platformio-udev.rules | sudo tee /etc/udev/rules.d/99-platformio-udev.rules
sudo service udev restart

# setting up users
# if Debian/Ubuntu
sudo usermod -a -G dialout $USER
sudo usermod -a -G plugdev $USER
# if Arch
sudo usermod -a -G uucp $USER
sudo usermod -a -G lock $USER

# platformIO cli command configuration
# add path or alias to you .bashrc or .zshrc
export PATH="$PATH:$HOME/.platformio/penv/bin"
# or
alias pio="$HOME/.platformio/penv/bin/pio"

# then reload your shell
source ~/.bashrc
# or
source ~/.zshrc

# If your board was plugged, please unplug and plug it again
`;
      var installStioGitTpl = `git clone git@github.com:DimitriGilbert/StationIO-Station.git StationIO`;
      var installStioTgzTpl = `STIOinstall_TMP_FILE=$(mktemp);
curl -LJ --output $STIOinstall_TMP_FILE "https://github.com/DimitriGilbert/StationIO-Station/archive/refs/heads/main.tar.gz";
tar -xzf $STIOinstall_TMP_FILE -C "./StationIO";
rm $STIOinstall_TMP_FILE;`;
      var installStioTpl = `<%~ it.stationInstall!==undefined?"# Install StationIO\\n"+it.stationInstall:"" %>

# Go to the station directory
cd StationIO

# create your station and copy "main.cpp" output to "stations/<%~ it.stationName %>.main.cpp"
./utils/createStation "<%~ it.stationName %>" -b nodemcuv2

# if you have custom sensors copy the code from the "sensors" tab to the relevant files in src/sensors/

<%~ it.libInstall %>
<% if(it.plugins!==undefined && it.plugins.install !== undefined && it.plugins.install !== "") {%>
# plugin install
<%~ it.plugins.install %>

<%} %>
# upload code to project board
./utils/uploadStation "<%~ it.stationName %>" --no-ota

# build filesystem
./utils/buildFS
# upload filesystem to project board
./utils/uploadStation "<%~ it.stationName %>" --no-ota --fs

# use serial monitor to get the IP address
# reset your board to see the initialisation output and get the ip address
pio device monitor -e nodemcuv2

# upload with an ip address, --ip is needed only the first time (it will be saved in ./stations/stations)
./utils/uploadStation "<%~ it.stationName %>" --ip <ip address>
`;

      // Sensor tpl
      var sensorHTpl = `#include <Arduino.h>
#include "../Sensor.h"
<% it.includes!==undefined?it.includes.forEach(function(i){ %> 
#include <<%= i %>> <%}):""; %> 

#ifndef StationIOSensor_<%= it.sensorName %>_h
#define StationIOSensor_<%= it.sensorName %>_h

class <%= it.sensorName %> : public Sensor
{
private:<% it.properties!==undefined&&it.properties.private!==undefined?it.properties.private.forEach(function(p){ %> 
  <%= p.type %> <%= p.name %>; <%}):""; %> 
public:<% it.properties!==undefined&&it.properties.public!==undefined?it.properties.public.forEach(function(p){ %> 
  <%= p.type %> <%= p.name %>; <%}):""; %> 
  <%= it.sensorName %>(<%= it.sensorInitializer!==undefined&&it.sensorInitializer.params!==undefined?it.sensorInitializer.params:"" %>);
  ~<%= it.sensorName %>();

  static const size_t mesuresCount = <%= it.mesuresCount %>;
  static const SensorMesure mesures[<%= it.mesuresCount %>];
  static const u_int *mesuresSampleRates[<%= it.mesuresCount %>];
  unsigned long mesuresSampleLast[<%= it.mesuresCount %>];

  SensorMesureData mesuresDatas[<%= it.mesuresCount %>];
  CircularBuffer<SensorMesureData,<%= it.mesuresBufferSize!==undefined?it.mesuresBufferSize:"20" %>> mesuresBuffers[<%= it.mesuresCount %>];
  
  void onSetup(StationClass station, int index);
  String getName();
  String getMesureName(u_int index);
  SensorMesure getMesure(u_int index);
  size_t getMesuresCount();
  SensorMesureData *read();
  SensorMesureData read(int index);
  SensorMesureData readBuffer(int index, int bufferIndex);
  void setMesure(int index, float value);
  SensorMesureData *average(int last);
  SensorMesureData average(int last, int index);
  String toString();
  String toString(int index);
  String toCsv();
  String toCsv(int index);
  String toJson();
  String toJson(int index);
  String toXml();
  String toXml(int index);
  String jsUtils();
  String toHtml();
  String toHtml(int index);
  SensorMesureData *read_();
  SensorMesureData read_(int index);
  void loop();
};

#endif`;
      var sensorCppTpl = `#include <Arduino.h>
#include "./<%= it.sensorName %>.h"

#include "./html.h"

<%= it.sensorName %>::<%= it.sensorName %>(<%= it.sensorInitializer!==undefined&&it.sensorInitializer.params!==undefined?it.sensorInitializer.params:"" %>) : Sensor("<%= it.sensorName %>") {<%= it.sensorInitializer!==undefined&&it.sensorInitializer.body!==undefined?it.sensorInitializer.body:"" %> 

  <% it.mesures.forEach(function(m, i){ %> 
    this->mesuresSampleLast[<%= i %>] = (unsigned long)<%= m.delayFirst!==undefined?m.delayFirst:"0" %>; 
<% }) %>
};
<%= it.sensorName %>::~<%= it.sensorName %>(){};

const <%= it.sensorName %>::SensorMesure <%= it.sensorName %>::mesures[<%= it.mesuresCount %>] = {<% it.mesures.forEach(function(m){ %> 
    {
      "<%= m.name %>",
      "<%= m.unit %>"
    },<%
  }) %>
};
const u_int *<%= it.sensorName %>::mesuresSampleRates[<%= it.mesuresCount %>] = {<% it.mesures.forEach(function(m){ %> 
    (const u_int *)<%= m.sampleRate %>,<%
  }) %>
};

void <%= it.sensorName %>::onSetup(StationClass station, int index) {<%= it.onSetup!=undefined?it.onSetup:"" %>}
size_t <%= it.sensorName %>::getMesuresCount() { return this->mesuresCount; }
Sensor::SensorMesureData *<%= it.sensorName %>::read_() {
  for (size_t i = 0; i < this->mesuresCount; i++) {
    this->mesuresDatas[i] = this->read_(i);
    this->mesuresBuffers[i].unshift(this->mesuresDatas[i]);
  }
  return this->mesuresDatas;
}
Sensor::SensorMesureData <%= it.sensorName %>::read_(int index) {
  if (index < this->mesuresCount) {
    Sensor::SensorMesureData value = 0;
    this->mesuresSampleLast[index] = millis();
    switch (index) {<% it.mesures.forEach(function(m, i){ %> 
      // mesure <%= m.name %> 
      case <%= i %>:
        <%= m.body!==undefined?m.body:"return 0;" %> 
        break;
<% }) %>
    }
    this->setMesure(index, value);
    return this->mesuresDatas[index];
  }
  return this->read_(<%= it.mesuresDefault!==undefined?it.mesuresDefault:"0" %>);
}
void <%= it.sensorName %>::setMesure(int index, float value) {
  this->mesuresDatas[index] = value;
  this->mesuresBuffers[index].unshift(this->mesuresDatas[index]);
}

void <%= it.sensorName %>::loop() {
  for (size_t i = 0; i < this->mesuresCount; i++) {
    if (millis() - this->mesuresSampleLast[i] > (unsigned long)this->mesuresSampleRates[i]) {
      this->read_(i);
    }
  }
}

Sensor::SensorMesureData *<%= it.sensorName %>::read() { return this->mesuresDatas; }

Sensor::SensorMesureData <%= it.sensorName %>::read(int index) {
  return this->__read(index, this->mesuresCount, this->mesuresDatas);
}

Sensor::SensorMesureData <%= it.sensorName %>::readBuffer(int index, int bufferIndex) {
  bufferIndex = bufferIndex > 40 ? 40 : bufferIndex < 0 ? 0 : bufferIndex;
  return this->mesuresBuffers[index][bufferIndex];
}

Sensor::SensorMesureData *<%= it.sensorName %>::average(int last) {
  Sensor::SensorMesureData data[this->mesuresCount];
  for (size_t i = 0; i < this->mesuresCount; i++) {
    data[i] = this->average(last, i);
  }

  return data;
}

Sensor::SensorMesureData <%= it.sensorName %>::average(int last, int index) {
  // return this->__average(last, index, this->mesuresCount, this->mesuresBuffers);
  if (index > this->mesuresCount) {
    return 0;
  }
  SensorMesureData data = 0;

  if (last > this->mesuresBuffers[index].size()) {
    last = this->mesuresBuffers[index].size();
  }

  for (size_t i = 0; i < last; i++) {
    data = data + this->mesuresBuffers[index][i];
  }
  return data / float(last);
}

String <%= it.sensorName %>::toString() {
  return SensorToString(this);
}
String <%= it.sensorName %>::toString(int index) {
  return SensorMesureToString(this->getMesure(index), this->read(index));
}
String <%= it.sensorName %>::toCsv() {
  return SensorToCsv(this);
}
String <%= it.sensorName %>::toCsv(int index) {
  return SensorMesureToCsv(this->getMesure(index), this->read(index));
}
String <%= it.sensorName %>::toJson() {
  return SensorToJson(this);
}
String <%= it.sensorName %>::toJson(int index) {
  return SensorMesureToJson(this->getMesure(index), this->read(index));
}
String <%= it.sensorName %>::toXml() {
  return SensorToXml(this);
}
String <%= it.sensorName %>::toXml(int index) {
  return SensorMesureToXml(this->getMesure(index), this->read(index));
}
String <%= it.sensorName %>::jsUtils() {
  return HtmlElt(
      "script",
      "const <%= it.sensorName %>_utils={};"
  );
}

String <%= it.sensorName %>::toHtml() {
  return SensorToHtml(this);
}
String <%= it.sensorName %>::toHtml(int index) {
  return SensorMesureToHtml(this->getMesure(index), this->read(index));
}
`;
    
      const StationIOPlugins = {
        install: [],
        include: [],
        declaration: [],
        setup: [],
        loop: [],
      };

      function getPluginsStr(where, configForm) {
        let out ="";
        StationIOPlugins[where].forEach((plugin) => {
          out += plugin(configForm);
        });
        return out;
      }
    </script>
    <script id="sensor.js">
      const sensorSelect = document.getElementById("sensor-select");
      const stationName = document.getElementById("station-name");
      const wifiSSID = document.getElementById("wifi-ssid");
      const wifiPass = document.getElementById("wifi-pass");
      const sensorsList = document.getElementById("sensors-list");

      const sensorForms = {
        dht11: () => {
          return `<div class="row">
            <label for="dht11-pin">pin</label>
            <input type="number" class="form-control" id="dht11-pin" name="dht11-pin" />
          </div>`;
        },
        mq2: () => {
          return `<div class="row">
            <label for="mq2-pin">pin</label>
            <input type="text" class="form-control" id="mq2-pin" name="mq2-pin" value="A0"/>
          </div>`;
        },
        mq135: () => {
          return `<div class="row">
            <label for="mq135-pin">pin</label>
            <input type="text" class="form-control" id="mq135-pin" name="mq135-pin" value="A0"/>
          </div>`;
        },
        custom:(sensorIndex) => {
          return `<input type="hidden" name="custom-index-${sensorIndex}" id="custom-index-${sensorIndex}" value="${sensorIndex}"/><div class="row">
            <label for="custom-name-${sensorIndex}">Name</label>
            <input type="text" class="form-control" id="custom-name-${sensorIndex}" name="custom-name-${sensorIndex}" onkeyup="this.parentNode.parentNode.firstElementChild.firstChild.textContent=this.value" />
          </div><div class="row">
            <label for="custom-mesure-${sensorIndex}-gen" class="form-check-label">Generate code</label>
            <input type="checkbox" class="form-check-input" id="custom-mesure-${sensorIndex}-gen" name="custom-mesure-${sensorIndex}-gen" onclick="this.checked?parentNode.nextElementSibling.classList.remove('d-none'):parentNode.nextElementSibling.classList.add('d-none')" />
          </div>
          <div class="d-none">
            <div class="row">
              <div class="col">
                <label for="custom-init-params-${sensorIndex}">Initialization parameter(-s comma separated)</label>
                <input type="text" class="form-control" id="custom-init-${sensorIndex}" name="custom-init-${sensorIndex}" />
              </div>
              <div class="col">
              <label for="custom-include-${sensorIndex}">Library(-ies comma separated)</label>
              <input type="text" class="form-control" id="custom-include-${sensorIndex}" name="custom-include-${sensorIndex}" />
              </div>
            </div><div class="row">
                <label for="custom-init-body-${sensorIndex}">Initialization body</label>
                <code-input lang="Arduino" class="form-control" id="custom-init-${sensorIndex}" name="custom-init-${sensorIndex}" ></code-input>
            </div><div class="row">
              <label for="custom-mesure-${sensorIndex}-gen-adv" class="form-check-label">advanced</label>
              <input type="checkbox" class="form-check-input" id="custom-mesure-${sensorIndex}-gen-adv" name="custom-mesure-${sensorIndex}-gen-adv" onclick="this.checked?parentNode.nextElementSibling.classList.remove('d-none'):parentNode.nextElementSibling.classList.add('d-none')" />
            </div><div class="d-none">
              <div class="row">
                <h3>Private properties<button class="btn btn-secondary btn-sm">+</button></h3>
                <div class="col">
                  <label for="custom-private-prop-name-${sensorIndex}">name</label>
                  <input type="text" class="form-control" id="custom-private-prop-name-${sensorIndex}" name="custom-private-prop-name-${sensorIndex}" />
                </div>
                <div class="col">
                  <label for="custom-private-prop-type-${sensorIndex}">name</label>
                  <input type="text" class="form-control" id="custom-private-prop-type-${sensorIndex}" name="custom-private-prop-type-${sensorIndex}" />
                </div>
              </div>
              <div class="row">
                <h3>Public properties<button class="btn btn-secondary btn-sm">+</button></h3>
                <div class="col">
                  <label for="custom-private-prop-name-${sensorIndex}">name</label>
                  <input type="text" class="form-control" id="custom-private-prop-name-${sensorIndex}" name="custom-private-prop-name-${sensorIndex}" />
                </div>
                <div class="col">
                  <label for="custom-private-prop-type-${sensorIndex}">name</label>
                  <input type="text" class="form-control" id="custom-private-prop-type-${sensorIndex}" name="custom-private-prop-type-${sensorIndex}" />
                </div>
              </div>
              <div class="row">
                <label for="custom-setup-${sensorIndex}">Setup</label>
                <code-input type="text" class="form-control" id="custom-setup-${sensorIndex}" name="custom-setup-${sensorIndex}" ></code-input>
              </div>
              <div class="row">
                <label for="custom-loop-${sensorIndex}">Loop</label>
                <code-input type="text" class="form-control" id="custom-loop-${sensorIndex}" name="custom-loop-${sensorIndex}" ></code-input>
              </div>
              </div>
              <div class="row">
                <h3>Mesures <button type="button" class="btn btn-secondary" onclick="customSensorMesureFrm(${sensorIndex})">+</button></h3>
                <input type="hidden" name="custom-mesure-count-${sensorIndex}" id="custom-mesure-count-${sensorIndex}" value="0"/>
                <div id="custom-mesure-list-${sensorIndex}"></div>
              </div>
            </div>`;
        },
      };

      const sensorParseForms = {
        dht11: (form) => {
          return ["dht11", form.get("dht11-pin")];
        },
        mq2: (form) => {
          return [
            "mq2",
            `${form.get("mq2-pin")}`,
          ];
        },
        mq135: (form) => {
          return [
            "mq135",
            `${form.get("mq135-pin")}`,
          ];
        },
        linky: (form) => {
          return [
            "linky",
            "tinfo",
            `// linky sensor init
void onLinkyData(ValueList* vallnk, uint8_t flag) {
  LinkyOnData(&station, vallnk, flag);
}
TInfo tinfo;
`,
          `// linky sensor loop
  if (Serial.available()) {
    char c = Serial.read();
    tinfo.process(c);
  }
`
          ];
        },
        custom: (form, index) => {
          let name = form.get(`custom-name-${index}`);
          let generate = form.get(`custom-mesure-${index}-gen`);
          let ret = name;
          if (generate == "on") {
            let tplData = {
              sensorName: name
            };
            
            let includes = form.get(`custom-include-${index}`);
            if (includes !== "" && includes !== null) {
              tplData.includes = includes.split(",");
            }

            let initParams = form.get(`custom-init-params-${index}`);
            if (initParams !== "" && initParams !== null) {
              tplData.init = {params:initParams.split(",")};
            }

            let initBody = form.get(`custom-init-body-${index}`);
            if (initBody !== "" && initBody !== null) {
              if (tplData.init === undefined) {
                tplData.init = {};
              }
              tplData.init.body = initBody;
            }
            
            let mcount = parseInt(form.get(`custom-mesure-count-${index}`));
            if (mcount > 0) {
              tplData.mesures = [];
              for(let i=0; i<mcount; i++){
                if (form.has(`custom-mesure-${index}-${i}-name`)) {

                  let mesure = {
                    name: form.get(`custom-mesure-${index}-${i}-name`),
                    unit: form.get(`custom-mesure-${index}-${i}-unit`),
                    sampleRate: form.get(`custom-mesure-${index}-${i}-sample`),
                  };
  
                  let sdelay = form.get(`custom-mesure-${index}-${i}-sample-delay`);
                  if (sdelay !== "") {
                    mesure.delayFirst = sdelay;
                  }
  
                  let body = form.get(`custom-mesure-${index}-${i}-body`);
                  if (body !== "") {
                    mesure.body = body;
                  }
  
                  tplData.mesures.push(mesure);
                }
              }
              tplData.mesuresCount = tplData.mesures.length;
            }
            
            ret = tplData.init===undefined?name:tplData.init.params===undefined?name:[name, tplData.init.params.join(",")];
            
            let soutEl = document.getElementById("stationio-custom-sensors").appendChild(
              htmlToElements(`<div id="stationio-custom-sensor-${index}">
                <p>Copy and paste the following code in your src/sensors/${name}.h and  src/sensors/${name}.cpp files</p>
                <div class="row">
                  <div class="col"><h3>${name}.h</h3><code-input lang="Arduino" id="${name}.h" value=""></code-input></div>
                  <div class="col"><h3>${name}.cpp</h3><code-input lang="Arduino" id="${name}.cpp" value=""></code-input></div>
                </div>
              </div>`)
            );
            soutEl.lastElementChild.firstElementChild.lastElementChild.value = eta.render(sensorHTpl, tplData);
            soutEl.lastElementChild.lastElementChild.lastElementChild.value = eta.render(sensorCppTpl, tplData);

            if (form.get(`custom-mesure-${index}-gen-adv`) == "on") {
              if (typeof ret == "string") {
                ret = [ret, ""];
              }
              let setupBody = form.get(`custom-setup-${index}`);
              if (setupBody !== null && setupBody !== "") {
                ret.push(setupBody);
              }
              let loopBody = form.get(`custom-loop-${index}`);
              if (loopBody !== null && loopBody !== "") {
                if (setupBody === null || setupBody === ""){ 
                  ret.push("");
                }
                ret.push(loopBody);
              }
            }
          }
          return ret;
        },
      };

      function customSensorMesureFrm(sensorIndex) {
        let mcel = document.getElementById(`custom-mesure-count-${sensorIndex}`);
        let mcount = parseInt(mcel.value);
        mcel.value = mcount+1;
        document.getElementById(`custom-mesure-list-${sensorIndex}`).appendChild(htmlToElements(`<div id="custom-mesure-${sensorIndex}-${mcount}">
          <span id="custom-mesure-${sensorIndex}-${mcount}-name-display"></span>
          <button type="button" class="btn btn-sm btn-danger" onclick="this.parentNode.parentNode.removeChild(this.parentNode)">X</button>
          <div class="row">
            <div class="col">
              <label for="custom-mesure-${sensorIndex}-${mcount}-name">Name</label>
              <input type="text" class="form-control" id="custom-mesure-${sensorIndex}-${mcount}-name" name="custom-mesure-${sensorIndex}-${mcount}-name" onkeyup="this.parentNode.parentNode.parentNode.firstElementChild.innerHTML=this.value" />
            </div><div class="col">
              <label for="custom-mesure-${sensorIndex}-${mcount}-unit">Unit</label>
              <input type="text" class="form-control" id="custom-mesure-${sensorIndex}-${mcount}-unit" name="custom-mesure-${sensorIndex}-${mcount}-unit" />
            </div>
          </div>
          <div class="row">
            <div class="col">
              <label for="custom-mesure-${sensorIndex}-${mcount}-sample">Sample Rate</label>
              <input type="number" class="form-control" id="custom-mesure-${sensorIndex}-${mcount}-sample" name="custom-mesure-${sensorIndex}-${mcount}-sample" value="2000" step="100" />
            </div><div class="col">
              <label for="custom-mesure-${sensorIndex}-${mcount}-sample-delay">Delay first sample</label>
              <input type="number" class="form-control" id="custom-mesure-${sensorIndex}-${mcount}-sample-delay" name="custom-mesure-${sensorIndex}-${mcount}-sample-delay" value="2000" step="100" />
            </div>
          </div>
          <div class="row">
            <label for="custom-mesure-${sensorIndex}-${mcount}-body">body</label>
            <code-input class="form-control" id="custom-mesure-${sensorIndex}-${mcount}-body" name="custom-mesure-${sensorIndex}-${mcount}-body" value="// set 'value' variable with the sensor read value\n// value = sensor->libObject->read();\nvalue = 42;"></code-input>
          </div>
          <div>`
        ));
      }

      document
        .getElementById("addSensorButton")
        .addEventListener("click", () => {
          let sensorIndex = parseInt(document.getElementById("sensor-index").value);
          const sensor = sensorSelect.value;
          const sensorOpt = document.getElementById(`sensor-opt-${sensor}`);
          let sensorForm = `<div class="row">
          <h3>${sensor} <button type="button" class="btn btn-danger btn-sm" onclick="this.parentNode.parentNode.parentNode.removeChild(this.parentNode.parentNode)">X</button></h3>
          <input type="hidden" name="sensors[]" value="${sensor}::${sensorIndex}"/>
          <input type="hidden" name="sensors_mesures[]" value="${sensorOpt.getAttribute("mesures")}"/>
          <input type="hidden" name="sensors_libs[]" value="${sensorOpt.getAttribute("libs")}"/>`;
          if (Object.keys(sensorForms).includes(sensor)) {
            sensorForm += sensorForms[sensor](sensorIndex);
          }
          sensorsList.appendChild(htmlToElements(sensorForm + "</div>"));
          document.getElementById("sensor-index").value = sensorIndex + 1;
        });
    </script>
    <script id="timer.js">
      const timersList = document.getElementById("timers-list");
      const timersCount = document.getElementById("timers-count");
      const addTimerButton = document.getElementById("addTimerButton");

      addTimerButton.addEventListener("click", () => {
        const timerId = timersCount.value;
        timersCount.value++;
        timersList.appendChild(
          htmlToElements(`<div class="row">
          <input type="hidden" name="timers[]" value="${timerId}"/>
          <h3><span id="timer-${timerId}-name-display">Timer ${timerId}</span> <button type="button" class="btn btn-secondary btn-sm" onclick="this.parentNode.parentNode.parentNode.removeChild(this.parentNode.parentNode);">X</button></h3>
          <div class="row">
            <div class="col">
              <label for="timer-${timerId}-name">Name</label>
              <input type="text" class="form-control" id="timer-${timerId}-name" name="timer-${timerId}-name" onKeyUp="document.getElementById('timer-${timerId}-name-display').innerHTML=this.value" />
            </div>
            <div class="col">
              <label for="timer-${timerId}-interval">Interval in milli seconds</label>
              <input type="number" class="form-control" id="timer-${timerId}-interval" name="timer-${timerId}-interval" value="1000" />
            </div>
          </div>
          <div class="row">
            <label for="timer-${timerId}-callback">Callback</label>
            <code-input lang="Arduino" class="form-textarea" id="timer-${timerId}-callback" name="timer-${timerId}-callback" value="// Example callback\n// @param station the station instance you will use to do stuff if you want\n[](BaseStation* station) {\n\tstation->log(station->toString());\n}"></code-input>
          </div>
        </div>`)
        );
      });
    </script>
    <script id="endpoint.js">
      const endpointsList = document.getElementById("endpoints-list");
      const endpointsCount = document.getElementById("endpoint-count");
      const addEndpointButton = document.getElementById("addEndpointButton");

      addEndpointButton.addEventListener("click", () => {
        const endpointId = endpointsCount.value;
        endpointsCount.value++;
        let epEl = endpointsList.appendChild(
          htmlToElements(`<div class="row">
          <input type="hidden" name="endpoints[]" value="${endpointId}"/>
          <h3><span id="endpoint-${endpointId}-route-display">Endpoint ${endpointId}</span> <button type="button" class="btn btn-secondary btn-sm" onclick="this.parentNode.parentNode.parentNode.removeChild(this.parentNode.parentNode);">X</button></h3>
          <div class="row">
            <label for="endpoint-${endpointId}-route">Route, starts with a "/" ("/", "/fancy", "/js" and "/css" are reserved)</label>
            <input type="text" class="form-control" id="endpoint-${endpointId}-route" name="endpoint-${endpointId}-route" onKeyUp="document.getElementById('endpoint-${endpointId}-route-display').innerHTML=this.value" />
          </div>
          <div class="row">
            <div class="col">
              <label for="endpoint-${endpointId}-login">Login</label>
              <input type="text" class="form-control" id="endpoint-${endpointId}-login" name="endpoint-${endpointId}-login"/>
            </div>
            <div class="col">
              <label for="endpoint-${endpointId}-password">Password</label>
              <input type="text" class="form-control" id="endpoint-${endpointId}-password" name="endpoint-${endpointId}-password"/>
            </div>
          </div>
          <div class="row">
            <label for="endpoint-${endpointId}-callback">Callback</label>
            <code-input lang="Arduino" class="form-textarea" id="endpoint-${endpointId}-callback" name="endpoint-${endpointId}-callback"></code-input>
          </div>
        </div>`)
        );
        epEl.lastElementChild.lastElementChild.value = `[](BaseStation* station, AsyncWebServerRequest* request) {\n\tstation->log("web server query");\n\trequest->send(200, "text/html", station->toHtml());\n}`;
      });
    </script>
    <script id="init.js">
      document
        .getElementById("stationio-config-frm")
        .addEventListener("change", (e) => {
          let frmData = new FormData(e.target.form);
          // reset sensor output
          document.getElementById("stationio-custom-sensors").innerHTML = "";

          const data = {
            name: frmData.get("station-name"),
            wifi: {
              ssid: frmData.get("wifi-ssid"),
              password: frmData.get("wifi-password"),
            },
            sensors: [],
            // callbacks: [],
            // loops:frmData,
            timers: [],
            webServerRoutes: [],
          };

          // TODO: get that to I2C plugin
          let i2ccl = frmData.get("i2c-clock");
          let i2cda = frmData.get("i2c-data");
          if (i2ccl !== "" && i2ccl !== null && i2cda !== "" && i2cda !== null) {
            data.i2c = [i2cda, i2ccl];
          }
          
          frmData.getAll("sensors[]").forEach((sensor, sensI) => {
            let snA = sensor.split("::");
            if (Object.keys(sensorParseForms).includes(snA[0])) {
              data.sensors.push(sensorParseForms[snA[0]](frmData, snA[1]));
            } else {
              data.sensors.push(snA[0]);
            }
          });
          frmData.getAll("timers[]").forEach((timer) => {
            data.timers.push({
              name: frmData.get(`timer-${timer}-name`),
              interval: frmData.get(`timer-${timer}-interval`),
              callback: frmData.get(`timer-${timer}-callback`),
            });
          });
          frmData.getAll("endpoints[]").forEach((endpts) => {
            data.webServerRoutes.push({
              url: frmData.get(`endpoint-${endpts}-route`),
              login: frmData.get(`endpoint-${endpts}-login`),
              password: frmData.get(`endpoint-${endpts}-password`),
              callback: frmData.get(`endpoint-${endpts}-callback`),
            });
          });

          data.plugins = {
            include:getPluginsStr("include",frmData),
            declaration: getPluginsStr("declaration",frmData),
            setup: getPluginsStr("setup",frmData),
            loop: getPluginsStr("loop",frmData),
          };

          document.getElementById("main-cpp-output").value = eta.render(
            mainCppTpl,
            data
          );
          
          document.getElementById("install-station-name").value = data.name;
          document.getElementById("install-config-frm").dispatchEvent(new Event('change'));
          
          if (document.getElementById("stationio-custom-sensors").innerHTML == "") {
            document.getElementById("stationio-custom-sensors").innerHTML = 'No custom sensors defined yet';
          }
        });
      document
        .getElementById("install-config-frm")
        .addEventListener("change", (evt)=>{
          let frmData = new FormData(evt.target.form!==undefined?evt.target.form:evt.target);
          new FormData(document.getElementById("stationio-config-frm")).forEach((v, k) => frmData.append(k, v));
          
          let data = {stationName: frmData.get("install-station-name")};
          let installTpl = frmData.has("install-station-pio")&&frmData.get("install-station-pio")=="on"?installPIOtpl+"\n":"";
          switch (frmData.get("install-station-type")) {
            case "none":
              break;
            case "tgz":
              data.stationInstall = eta.render(installStioTgzTpl, data)+"\n";
              break;
            case "git":
            default:
              data.stationInstall = eta.render(installStioGitTpl, data)+"\n";
              break;
          }
          installTpl += "\n"+installStioTpl;
          
          let pioLibs = [];
          let snLibs = frmData.getAll("sensors_libs[]");
          for (const sli in snLibs) {
            pioLibs = pioLibs.concat(snLibs[sli].split(',').filter(el => !pioLibs.includes(el)));
          }
          data.libInstall = pioLibs.length>0?`# Installing dependencies using PlatformIO
pio pkg install --library "${pioLibs.join('" --library "')}"

`:"";

          data.plugins = {
            install: getPluginsStr("install", frmData),
          };
          
          document.getElementById("install-output").value = eta.render(
            installTpl,
            data
          );
        });
      
      // onload event for the page
      window.addEventListener("load", () => {
        codeInput.registerTemplate(
          "code-input",
          codeInput.templates.prism(Prism, [new codeInput.plugins.Indent()])
        );
        document.getElementById("main-cpp-output").style.height =
          window.innerHeight - 100 + "px";
        document.getElementById("install-output").style.height =
          window.innerHeight - 250 + "px";
        
        document.getElementsByTagName("h1")[1].addEventListener('dblclick', (event) => {
          new bootstrap.Modal('#pluginModal', {}).show()
        });
        document.querySelectorAll("#plugins-list>li>a").forEach(el => {
          el.addEventListener('click', (event) => {
            event.preventDefault();
            addScript(event.target.getAttribute('href'));
          });
        })
      });
      window.addEventListener("resize", () => {
        document.getElementById("main-cpp-output").style.height =
          window.innerHeight - 100 + "px";
      });
      
      // initializing navigation
      document
        .querySelectorAll("[navTo]")
        .forEach((el) => {
          el.addEventListener("click", evt => {
            navTo(evt.target.getAttribute("navTo"));
          })
        });
    </script>
    
    <!-- bootstrap -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
      crossorigin="anonymous"
    ></script>
    <!-- code-input -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/components/prism-core.min.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/plugins/autoloader/prism-autoloader.min.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/gh/WebCoder49/code-input@1.1/code-input.min.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/gh/WebCoder49/code-input@1.1/plugins/indent.js"
      crossorigin="anonymous"
    ></script>
    <!-- eta -->
    <script
      src="https://cdn.jsdelivr.net/npm/eta"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
